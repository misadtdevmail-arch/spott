import{a as B,T as F,c as I,l as w,P as b,f as i,ad as R,ae as C,i as A,af as T,a2 as v,V as M,u as P,_ as $,g as V,w as d,r as c,o as r,h as u,m as s,B as l,Z as y,t as o,F as _,C as x,k}from"./index-CVlYEBNf.js";import{c as q,s as H}from"./datetime-B2PT4Ag7.js";const Q=B({components:{IonPage:I,IonContent:F},data(){return{userinfo:{},location:[],showBtn:!1,procLog:P()}},computed:{initialApproverName(){const e=this.userinfo;return e.initialApproverName?e.initialApproverName.split("|"):[]},finalApproverName(){const e=this.userinfo;return e.finalApproverName?e.finalApproverName.split("|"):[]}},async ionViewWillEnter(){const{value:e}=await b.get({key:"userinfo"});this.userinfo=JSON.parse(e||""),await this.getRegisteredLocation()},methods:{async getRegisteredLocation(){if(this.platform=="web"){const{data:e}=await this.$api.getAllowedLocation({method:"post",data:{username:this.userinfo.username}});this.location=e?e.allowed_location:[],this.showBtn=e.allowed_location.length<parseInt(this.userinfo.noOfLocations)}else{const t=await this.procLog.selectQuery("SELECT * FROM allowed_locations");t&&t.length>=0&&(this.location=t,this.showBtn=t.length<parseInt(this.userinfo.noOfLocations))}},async getLocation(e){const t="https://nominatim.openstreetmap.org/reverse?lat=".concat(e.latitude,"&lon=").concat(e.longitude,"&format=json"),{data:a}=await M.request({method:"GET",url:t,headers:{"User-Agent":"spott/1.2.30 (misadtdevmail@gmail.com)",Accept:"application/json"}});return a.display_name},async calibrate(){if(A.value){const e=await w.create({message:"Getting location details, please wait..",translucent:!0,spinner:"lines"});if(this.location.length<parseInt(this.userinfo.noOfLocations))if(this.platform=="web"){const t=await w.create({message:"Fetching location..",translucent:!0,spinner:"lines"});t.present(),navigator.geolocation.getCurrentPosition(async a=>{const{coords:n}=a;if(n){await t.dismiss(),e.present();const{latitude:m,longitude:p}=a.coords,g=await this.getLocation({latitude:m,longitude:p});g?(await e.dismiss(),await(await i.create({header:"Fetch location successful!",subHeader:"Do you want to register this location?",message:g,backdropDismiss:!1,buttons:[{text:"Cancel",role:"cancel"},{text:"Register",handler:async()=>{await this.registerLocation({latitude:m,longitude:p,description:g})}}]})).present()):(await e.dismiss(),await(await i.create({header:"System Alert!",message:"Failed to obtain location description. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present())}else await(await i.create({header:"System Alert!",message:"Failed to obtain location description. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present()},async a=>{a.code==1?await(await i.create({header:"System Alert!",message:"SPOTT location permission is restricted.",backdropDismiss:!1,buttons:["Okay"]})).present():await(await i.create({header:"System Alert!",message:"Failed to obtain location description. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present()})}else try{if(await q(),H.value&&(await T(),v.value&&Object.keys(v.value).length>0)){const t=v.value;if(await e.present(),Math.round(t.coords.accuracy)<=30){const a=await this.getLocation(t.coords);a?(t.coords.description=a,await e.dismiss(),await(await i.create({header:"Fetch location successful!",subHeader:"Do you want to register this location?",message:a,backdropDismiss:!1,buttons:[{text:"Cancel",role:"cancel"},{text:"Register",handler:async()=>{await this.registerLocation(t.coords)}}]})).present()):(await e.dismiss(),await(await i.create({header:"System Alert!",message:"Failed to obtain location description. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present())}else await e.dismiss(),await(await i.create({header:"System Alert!",message:"Failed to obtain an accurate location. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present()}}catch(t){await e.dismiss(),alert(t)}else await(await i.create({header:"System Alert!",message:"Maximum allowed location is reached.",backdropDismiss:!1,buttons:["Okay"]})).present()}else await(await i.create({header:"System Alert!",message:"Please ensure you have a stable internet connection.",backdropDismiss:!1,buttons:["Okay"]})).present()},async registerLocation(e){if(A.value){const t=await w.create({message:"Registering location to the server, please wait...",translucent:!0,spinner:"lines"});t.present();try{const{data:a}=await this.$api.registerLocation({method:"post",data:{username:this.userinfo.username,longitude:e.longitude,latitude:e.latitude,description:e.description}});if(a)if(this.platform=="web")await t.dismiss(),await this.getRegisteredLocation();else{const n="INSERT INTO allowed_locations (username,longitude,latitude,description) VALUES (?,?,?,?)",m=[this.userinfo.username,e.longitude,e.latitude,e.description],p=await this.procLog.runQuery(n,m);p!=null&&p.lastId&&(await t.dismiss(),await this.getRegisteredLocation())}else await t.dismiss(),await(await i.create({header:"System Alert!",message:"Location already registered, location must be unique.",backdropDismiss:!1,buttons:["Okay"]})).present()}catch(a){await t.dismiss(),await(await i.create({header:"System Alert!",message:"Server unreachable, failed to register location.",backdropDismiss:!1,buttons:["Okay"]})).present()}}else await(await i.create({header:"System Alert!",message:"Please ensure you have a stable internet connection.",backdropDismiss:!1,buttons:["Okay"]})).present()},async logout(){const e=await w.create({message:"Logging out, please wait..",translucent:!0,spinner:"lines"});await e.present();try{if(this.platform=="web")await b.clear(),this.$router.push({path:"/login"});else{const t=await this.procLog.selectQuery("SELECT * from attlogs WHERE status = 0 ORDER BY id ASC");if(t!=null&&t.length)await(await i.create({header:"System Alert!",message:"Offline logs must be uploaded first before you can log out from this device.",backdropDismiss:!1,buttons:["Okay"]})).present();else{const a=new R(C);(await a.isConnection("spottdb",!1)).result&&await a.closeConnection("spottdb",!1),await C.deleteDatabase({database:"spottdb"}),await b.clear(),this.$router.push({path:"/login"})}}}catch(t){alert(t)}finally{await e.dismiss()}}}}),U={class:"pt-2"},z={class:"d-block"},G={class:"d-block"},j={class:"d-block"},W={class:"text-center pb-4 px-4 pt-0 mt-2"},J={class:"d-flex text-wrap"},Y={class:"font-weight-regular"},Z={class:"d-flex text-wrap"},K={class:"font-weight-regular"},X={class:"d-flex text-wrap"},tt={class:"font-weight-regular"},et={class:"d-flex text-wrap"},st={class:"font-weight-regular"},at={class:"d-flex text-wrap"},ot={class:"font-weight-regular"},it={class:"text-center pb-4 px-4 pt-0 mt-2"},nt={class:"d-flex text-wrap"},rt={class:"font-weight-regular"},lt={class:"d-flex text-wrap"},dt={class:"font-weight-regular"},ct={class:"d-flex text-wrap"},ut={class:"font-weight-regular"},pt={class:"d-flex text-wrap"},ft={class:"font-weight-regular"},mt={key:0,class:"d-flex text-wrap"},gt={class:"font-weight-regular"},wt={key:0,class:"text-center pb-4 px-4 pt-0 mt-2"},ht={key:0},bt={class:"text-wrap mt-5"},vt={class:"font-weight-regular mb-5"},yt={class:"mt-5"};function _t(e,t,a,n,m,p){const g=c("v-img"),h=c("v-card-title"),S=c("v-card"),L=c("v-btn"),O=c("v-icon"),D=c("v-container"),E=c("ion-content"),N=c("ion-page");return r(),V(N,null,{default:d(()=>[u(E,null,{default:d(()=>[u(D,{fluid:"",class:"mx-auto px-3",width:e.platform=="web"&&!e.isMobile?"50%":""},{default:d(()=>[u(S,{elevation:"0",color:"blue-grey-darken-4",class:"mx-auto rounded-lg"},{default:d(()=>[s("div",U,[u(g,{src:"/user.png","max-width":"120",class:"rounded-circle mx-auto"})]),u(h,{class:"text-center text-overline pb-5 text-wrap",style:{"font-size":"18px !important"}},{default:d(()=>[s("span",z,o(e.userinfo.EMPNUMB),1),s("span",G,o(e.userinfo.fullName),1),s("span",j,o(e.userinfo.posdesc),1)]),_:1})]),_:1}),s("fieldset",W,[t[7]||(t[7]=s("legend",{class:"text-overline font-weight-medium",style:{"font-size":"16px !important"}},"Employment Information",-1)),s("div",J,[t[2]||(t[2]=s("div",{class:"text-label font-weight-bold text-start"},"Company:",-1)),s("div",Y,o(e.userinfo.cmpname),1)]),s("div",Z,[t[3]||(t[3]=s("div",{class:"text-label font-weight-bold text-start"},"Department:",-1)),s("div",K,o(e.userinfo.department),1)]),s("div",X,[t[4]||(t[4]=s("div",{class:"text-label font-weight-bold text-start"},"Shift Schedule:",-1)),s("div",tt,o(e.userinfo.EMPSHFT)+" - ("+o(e.userinfo.TIME_IN)+" - "+o(e.userinfo.TIME_OUT)+")",1)]),s("div",et,[t[5]||(t[5]=s("div",{class:"text-label font-weight-bold text-start"},"Restday Code:",-1)),s("div",st,o(e.userinfo.EMVRDCD),1)]),s("div",at,[t[6]||(t[6]=s("div",{class:"text-label font-weight-bold text-start"},"Base Location:",-1)),s("div",ot,o(e.userinfo.EMVLCCD),1)])]),s("fieldset",it,[t[13]||(t[13]=s("legend",{class:"text-overline font-weight-medium",style:{"font-size":"16px !important"}},"SPOTT CONFIGURATION",-1)),s("div",nt,[t[8]||(t[8]=s("div",{class:"text-label font-weight-bold text-start"},"Image Capture:",-1)),s("div",rt,o(e.userinfo.imageCapture==1?"Required":"Not needed"),1)]),s("div",lt,[t[9]||(t[9]=s("div",{class:"text-label font-weight-bold text-start"},"Geo Fence Mode:",-1)),s("div",dt,o(e.userinfo.geoFenceMode==1?"Enabled":"Disabled"),1)]),s("div",ct,[t[10]||(t[10]=s("div",{class:"text-label font-weight-bold text-start"},"Initial Approver:",-1)),s("div",ut,[(r(!0),l(_,null,x(e.initialApproverName,f=>(r(),l("div",null,o(f),1))),256))])]),s("div",pt,[t[11]||(t[11]=s("div",{class:"text-label font-weight-bold text-start"},"Final Approver:",-1)),s("div",ft,[(r(!0),l(_,null,x(e.finalApproverName,f=>(r(),l("div",null,o(f),1))),256))])]),e.userinfo.geoFenceMode==1?(r(),l("div",mt,[t[12]||(t[12]=s("div",{class:"text-label font-weight-bold text-start"},"Max allowed location:",-1)),s("div",gt,o(e.userinfo.noOfLocations),1)])):y("",!0)]),e.userinfo.geoFenceMode==1?(r(),l("fieldset",wt,[t[15]||(t[15]=s("legend",{class:"text-overline font-weight-medium",style:{"font-size":"16px !important"}},"Registered Location",-1)),e.showBtn?(r(),l("div",ht,[u(L,{color:"primary",onClick:t[0]||(t[0]=f=>e.calibrate())},{default:d(()=>t[14]||(t[14]=[k("Calibrate Location")])),_:1})])):y("",!0),s("div",bt,[(r(!0),l(_,null,x(e.location,f=>(r(),l("div",vt,o(f.description),1))),256))])])):y("",!0),s("div",yt,[u(L,{block:"",color:"secondary",onClick:t[1]||(t[1]=f=>e.logout())},{default:d(()=>[u(O,null,{default:d(()=>t[16]||(t[16]=[k("mdi-logout-variant")])),_:1}),t[17]||(t[17]=k(" Logout "))]),_:1})])]),_:1},8,["width"])]),_:1})]),_:1})}const Lt=$(Q,[["render",_t],["__scopeId","data-v-bdf24889"]]);export{Lt as default};
