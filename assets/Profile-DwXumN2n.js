import{a as N,S as R,Q as T,I as B,R as F,c as M,l as w,f as i,ae as P,af as L,P as C,i as S,ag as $,a2 as b,U as V,u as q,_ as H,g as Q,w as d,r as c,o as r,h as u,k as s,Y as l,C as v,t as o,Z as y,ac as _,m as x}from"./index-B4PYElqd.js";import{c as U,s as z}from"./datetime-BXnkmoWv.js";const G=N({components:{IonPage:M,IonHeader:F,IonTitle:B,IonToolbar:T,IonContent:R},data(){return{userinfo:{},location:[],showBtn:!1,procLog:q()}},computed:{initialApproverName(){const e=this.userinfo;return e.initialApproverName?e.initialApproverName.split("|"):[]},finalApproverName(){const e=this.userinfo;return e.finalApproverName?e.finalApproverName.split("|"):[]}},async ionViewWillEnter(){const{value:e}=await C.get({key:"userinfo"});this.userinfo=JSON.parse(e||""),await this.getRegisteredLocation()},methods:{async getRegisteredLocation(){if(this.platform=="web"){const{data:e}=await this.$api.getAllowedLocation({method:"post",data:{username:this.userinfo.username}});this.location=e?e.allowed_location:[],this.showBtn=e.allowed_location.length<parseInt(this.userinfo.noOfLocations)}else{const t=await this.procLog.selectQuery("SELECT * FROM allowed_locations");t&&t.length>0&&(this.location=t,this.showBtn=t.length<parseInt(this.userinfo.noOfLocations))}},async getLocation(e){const t="https://nominatim.openstreetmap.org/reverse?lat=".concat(e.latitude,"&lon=").concat(e.longitude,"&format=json"),{data:a}=await V.request({method:"GET",url:t,headers:{"User-Agent":"spott/1.2.30 (misadtdevmail@gmail.com)",Accept:"application/json"}});return a.display_name},async calibrate(){if(S.value){const e=await w.create({message:"Getting location details, please wait..",translucent:!0,spinner:"lines"});if(this.location.length<parseInt(this.userinfo.noOfLocations))if(this.platform=="web"){const t=await w.create({message:"Fetching location..",translucent:!0,spinner:"lines"});t.present(),navigator.geolocation.getCurrentPosition(async a=>{const{coords:n}=a;if(n){await t.dismiss(),e.present();const{latitude:m,longitude:p}=a.coords,g=await this.getLocation({latitude:m,longitude:p});g?(await e.dismiss(),await(await i.create({header:"Fetch location successful!",subHeader:"Do you want to register this location?",message:g,backdropDismiss:!1,buttons:[{text:"Cancel",role:"cancel"},{text:"Register",handler:async()=>{await this.registerLocation({latitude:m,longitude:p,description:g})}}]})).present()):(await e.dismiss(),await(await i.create({header:"System Alert!",message:"Failed to obtain location description. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present())}else await(await i.create({header:"System Alert!",message:"Failed to obtain location description. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present()},async a=>{a.code==1?await(await i.create({header:"System Alert!",message:"SPOTT location permission is restricted.",backdropDismiss:!1,buttons:["Okay"]})).present():await(await i.create({header:"System Alert!",message:"Failed to obtain location description. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present()})}else try{if(await U(),z.value&&(await $(),b.value&&Object.keys(b.value).length>0)){const t=b.value;if(await e.present(),Math.round(t.coords.accuracy)<=30){const a=await this.getLocation(t.coords);a?(t.coords.description=a,await e.dismiss(),await(await i.create({header:"Fetch location successful!",subHeader:"Do you want to register this location?",message:a,backdropDismiss:!1,buttons:[{text:"Cancel",role:"cancel"},{text:"Register",handler:async()=>{await this.registerLocation(t.coords)}}]})).present()):(await e.dismiss(),await(await i.create({header:"System Alert!",message:"Failed to obtain location description. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present())}else await e.dismiss(),await(await i.create({header:"System Alert!",message:"Failed to obtain an accurate location. Please retry.",backdropDismiss:!1,buttons:["Okay"]})).present()}}catch(t){await e.dismiss(),alert(t)}else await(await i.create({header:"System Alert!",message:"Maximum allowed location is reached.",backdropDismiss:!1,buttons:["Okay"]})).present()}else await(await i.create({header:"System Alert!",message:"Please ensure you have a stable internet connection in order to calibrate your location.",backdropDismiss:!1,buttons:["Okay"]})).present()},async registerLocation(e){if(S.value){const t=await w.create({message:"Registering location to the server, please wait...",translucent:!0,spinner:"lines"});t.present();try{const{data:a}=await this.$api.registerLocation({method:"post",data:{username:this.userinfo.username,longitude:e.longitude,latitude:e.latitude,description:e.description}});if(a)if(this.platform=="web")await t.dismiss(),await this.getRegisteredLocation();else{const n="INSERT INTO allowed_locations (username,longitude,latitude,description) VALUES (?,?,?,?)",m=[this.userinfo.username,e.longitude,e.latitude,e.description],p=await this.procLog.runQuery(n,m);p!=null&&p.lastId&&(await t.dismiss(),await this.getRegisteredLocation())}else await t.dismiss(),await(await i.create({header:"System Alert!",message:"Location already registered, location must be unique.",backdropDismiss:!1,buttons:["Okay"]})).present()}catch(a){await t.dismiss(),await(await i.create({header:"System Alert!",message:"Server unreachable, failed to register location.",backdropDismiss:!1,buttons:["Okay"]})).present()}}else await(await i.create({header:"System Alert!",message:"Internet connection is disconnected.",backdropDismiss:!1,buttons:["Okay"]})).present()},async logout(){const e=await w.create({message:"Logging out, please wait..",translucent:!0,spinner:"lines"});await e.present();try{const t=await this.procLog.selectQuery("SELECT * from attlogs WHERE status = 0 ORDER BY id ASC");if(t!=null&&t.length)await(await i.create({header:"System Alert!",message:"Offline logs must be uploaded first before you can log out from this device.",backdropDismiss:!1,buttons:["Okay"]})).present();else{const a=new P(L);(await a.isConnection("spottdb",!1)).result&&await a.closeConnection("spottdb",!1),await L.deleteDatabase({database:"spottdb"}),await C.clear(),this.$router.push({path:"/login"})}}catch(t){alert(t)}finally{await e.dismiss()}}}}),j={class:"pt-2"},W={class:"d-block"},Y={class:"d-block"},J={class:"d-block"},Z={class:"text-center pb-4 px-4 pt-0 mt-2"},K={class:"d-flex text-wrap"},X={class:"font-weight-regular"},tt={class:"d-flex text-wrap"},et={class:"font-weight-regular"},st={class:"d-flex text-wrap"},at={class:"font-weight-regular"},ot={class:"d-flex text-wrap"},it={class:"font-weight-regular"},nt={class:"d-flex text-wrap"},rt={class:"font-weight-regular"},lt={class:"text-center pb-4 px-4 pt-0 mt-2"},dt={class:"d-flex text-wrap"},ct={class:"font-weight-regular"},ut={class:"d-flex text-wrap"},pt={class:"font-weight-regular"},ft={class:"d-flex text-wrap"},mt={class:"font-weight-regular"},gt={class:"d-flex text-wrap"},wt={class:"font-weight-regular"},ht={key:0,class:"d-flex text-wrap"},bt={class:"font-weight-regular"},vt={key:0,class:"text-center pb-4 px-4 pt-0 mt-2"},yt={key:0},_t={class:"text-wrap mt-5"},xt={class:"font-weight-regular mb-5"},kt={class:"mt-5"};function Lt(e,t,a,n,m,p){const g=c("v-img"),h=c("v-card-title"),A=c("v-card"),k=c("v-btn"),O=c("v-icon"),D=c("v-container"),I=c("ion-content"),E=c("ion-page");return r(),Q(E,null,{default:d(()=>[u(I,null,{default:d(()=>[u(D,{fluid:"",class:"mx-auto px-3",width:e.platform=="web"&&!e.isMobile?"50%":""},{default:d(()=>[u(A,{elevation:"0",color:"blue-grey-darken-4",class:"mx-auto rounded-lg"},{default:d(()=>[s("div",j,[u(g,{src:"/user.png","max-width":"120",class:"rounded-circle mx-auto"})]),u(h,{class:"text-center text-overline pb-5 text-wrap",style:{"font-size":"18px !important"}},{default:d(()=>[s("span",W,o(e.userinfo.EMPNUMB),1),s("span",Y,o(e.userinfo.fullName),1),s("span",J,o(e.userinfo.posdesc),1)]),_:1})]),_:1}),s("fieldset",Z,[t[7]||(t[7]=s("legend",{class:"text-overline font-weight-medium",style:{"font-size":"16px !important"}},"Employment Information",-1)),s("div",K,[t[2]||(t[2]=s("div",{class:"text-label font-weight-bold text-start"},"Company:",-1)),s("div",X,o(e.userinfo.cmpname),1)]),s("div",tt,[t[3]||(t[3]=s("div",{class:"text-label font-weight-bold text-start"},"Department:",-1)),s("div",et,o(e.userinfo.department),1)]),s("div",st,[t[4]||(t[4]=s("div",{class:"text-label font-weight-bold text-start"},"Shift Schedule:",-1)),s("div",at,o(e.userinfo.EMPSHFT)+" - ("+o(e.userinfo.TIME_IN)+" - "+o(e.userinfo.TIME_OUT)+")",1)]),s("div",ot,[t[5]||(t[5]=s("div",{class:"text-label font-weight-bold text-start"},"Restday Code:",-1)),s("div",it,o(e.userinfo.EMVRDCD),1)]),s("div",nt,[t[6]||(t[6]=s("div",{class:"text-label font-weight-bold text-start"},"Base Location:",-1)),s("div",rt,o(e.userinfo.EMVLCCD),1)])]),s("fieldset",lt,[t[13]||(t[13]=s("legend",{class:"text-overline font-weight-medium",style:{"font-size":"16px !important"}},"SPOTT CONFIGURATION",-1)),s("div",dt,[t[8]||(t[8]=s("div",{class:"text-label font-weight-bold text-start"},"Image Capture:",-1)),s("div",ct,o(e.userinfo.imageCapture==1?"Required":"Not needed"),1)]),s("div",ut,[t[9]||(t[9]=s("div",{class:"text-label font-weight-bold text-start"},"Geo Fence Mode:",-1)),s("div",pt,o(e.userinfo.geoFenceMode==1?"Enabled":"Disabled"),1)]),s("div",ft,[t[10]||(t[10]=s("div",{class:"text-label font-weight-bold text-start"},"Initial Approver:",-1)),s("div",mt,[(r(!0),l(y,null,_(e.initialApproverName,f=>(r(),l("div",null,o(f),1))),256))])]),s("div",gt,[t[11]||(t[11]=s("div",{class:"text-label font-weight-bold text-start"},"Final Approver:",-1)),s("div",wt,[(r(!0),l(y,null,_(e.finalApproverName,f=>(r(),l("div",null,o(f),1))),256))])]),e.userinfo.geoFenceMode==1?(r(),l("div",ht,[t[12]||(t[12]=s("div",{class:"text-label font-weight-bold text-start"},"Max allowed location:",-1)),s("div",bt,o(e.userinfo.noOfLocations),1)])):v("",!0)]),e.userinfo.geoFenceMode==1?(r(),l("fieldset",vt,[t[15]||(t[15]=s("legend",{class:"text-overline font-weight-medium",style:{"font-size":"16px !important"}},"Registered Location",-1)),e.showBtn?(r(),l("div",yt,[u(k,{color:"primary",onClick:t[0]||(t[0]=f=>e.calibrate())},{default:d(()=>t[14]||(t[14]=[x("Calibrate Location")])),_:1})])):v("",!0),s("div",_t,[(r(!0),l(y,null,_(e.location,f=>(r(),l("div",xt,o(f.description),1))),256))])])):v("",!0),s("div",kt,[u(k,{block:"",color:"secondary",onClick:t[1]||(t[1]=f=>e.logout())},{default:d(()=>[u(O,null,{default:d(()=>t[16]||(t[16]=[x("mdi-logout-variant")])),_:1}),t[17]||(t[17]=x(" Logout "))]),_:1})])]),_:1},8,["width"])]),_:1})]),_:1})}const At=H(G,[["render",Lt],["__scopeId","data-v-f5305682"]]);export{At as default};
